name: Test

on:
  push:
    branches: [main]
    paths:
      - ".github/workflows/test.yml"
      - "src/**"
      - "test/**"
  pull_request:
    branches: [main]
    paths:
      - ".github/workflows/test.yml"
      - "src/**"
      - "test/**"

jobs:
  linux-test:
    name: Linux Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛒
        uses: actions/checkout@v2
      - name: Build 🏗️
        run: make
      - name: Test 🧪
        run: make test

  linux-memcheck:
    name: Linux Memcheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛒
        uses: actions/checkout@v2
      - name: Install dependencies 📦
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: valgrind
          version: 1.0
      - name: Build 🏗️
        run: make
      - name: Memcheck 🧠
        run: make memcheck

  macos-test:
    name: macOS Test
    runs-on: macos-latest
    steps:
      - name: Checkout 🛒
        uses: actions/checkout@v2
      - name: Build 🏗️
        run: make
      - name: Test 🧪
        run: make test
      # - name: Upload artifact 📤
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: macos-test
      #     path: dist/

  # macos-memcheck:
  #   name: macOS Memcheck
  #   runs-on: macos-latest
  #   needs: macos-test
  #   steps:
  #     - name: Checkout 🛒
  #       uses: actions/checkout@v2
  #     - name: Install dependencies 📦
  #       run: |
  #         brew tap LouisBrunner/valgrind
  #         brew install --HEAD LouisBrunner/valgrind/valgrind
  #     - name: Download artifact 📥
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: macos-test
  #         path: dist/
  #     - name: Fix permissions 🛠️
  #       run: chmod -vR +x dist/unix/bin
  #     - name: Memcheck 🧠
  #       run: make memcheck

  windows-test:
    name: Windows Test
    runs-on: windows-latest
    steps:
      - name: Checkout 🛒
        uses: actions/checkout@v2
      - name: Build 🏗️
        run: make
      - name: Test 🧪
        run: make test
